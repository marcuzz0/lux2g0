<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>lux2g0</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg-primary:#0f0f14;--bg-secondary:#1a1a24;--bg-tertiary:#252533;--text-primary:#ffffff;--text-secondary:#b0b0b0;--accent:#d85652;--success:#4CAF50;--danger:#c94333;--border:#2a2a3e;--header-bg:#d85652}
body.light{--bg-primary:#f5f5f5;--bg-secondary:#fff;--bg-tertiary:#e0e0e0;--text-primary:#333;--text-secondary:#666;--accent:#2196F3;--danger:#f44336;--border:#ddd;--header-bg:#2196F3}
body{font-family:Arial,sans-serif;background:var(--bg-primary);color:var(--text-primary);margin:0;padding-top:60px;visibility:hidden}
.header{position:fixed;top:0;left:0;right:0;height:60px;background:var(--header-bg);display:flex;align-items:center;justify-content:space-between;padding:0 20px;box-shadow:0 2px 10px rgba(0,0,0,0.2);z-index:100}
.header h1{color:#fff;font-size:24px;font-weight:600}
.header-buttons{display:flex;gap:10px;align-items:center}
.icon-button{background:rgba(255,255,255,0.2);border:none;width:40px;height:40px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.3s ease}
.icon-button:hover{background:rgba(255,255,255,0.3);transform:scale(1.05)}
.icon-button svg{width:24px;height:24px;fill:white}
.container{padding:20px}
.section{background:var(--bg-secondary);border-radius:8px;padding:20px;margin-bottom:20px}
.section h2{color:var(--accent);margin-bottom:15px}
.input-field{width:100%;padding:10px;margin:5px 0;background:var(--bg-tertiary);border:1px solid var(--border);border-radius:5px;color:var(--text-primary)}
.button{min-width:120px;height:48px;padding:12px 30px;background:var(--accent);color:white;border:none;border-radius:5px;cursor:pointer;margin:5px;font-size:16px;font-weight:500;transition:all 0.3s ease;display:inline-flex;align-items:center;justify-content:center}
.button:hover{opacity:0.9;transform:translateY(-1px)}
.button:disabled{opacity:0.6;cursor:not-allowed;transform:none}
.network-item{padding:10px;background:var(--bg-tertiary);border-radius:5px;margin:5px 0;display:flex;justify-content:space-between;align-items:center}
.theme-toggle{display:flex;align-items:center;justify-content:space-between;padding:10px;background:var(--bg-tertiary);border-radius:5px;width:100%}
.switch{position:relative;display:inline-block;width:60px;height:34px}
.switch input{opacity:0;width:0;height:0}
.switch input:disabled+.slider{opacity:0.5;cursor:not-allowed}
.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:var(--text-secondary);border-radius:34px}
.slider:before{position:absolute;content:"";height:26px;width:26px;left:4px;bottom:4px;background:white;transition:.4s;border-radius:50%}
input:checked+.slider{background:var(--accent)}
input:checked+.slider:before{transform:translateX(26px)}
</style>
</head>
<body>
<script>
if(localStorage.getItem('theme')==='light'){document.body.classList.add('light');}
document.body.style.visibility='visible';
// Polyfill for deprecated setCapture
if(!Element.prototype.setPointerCapture && Element.prototype.setCapture){
  Element.prototype.setPointerCapture = Element.prototype.setCapture;
}
</script>
<div class="header">
<h1>lux2g0</h1>
<div class="header-buttons">
<button class="icon-button" onclick="location.href='/'">
<svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
</button>
<button class="icon-button" onclick="location.href='/settings'">
<svg viewBox="0 0 24 24"><path d="M12 15.5A3.5 3.5 0 0 1 8.5 12A3.5 3.5 0 0 1 12 8.5a3.5 3.5 0 0 1 3.5 3.5a3.5 3.5 0 0 1-3.5 3.5m7.43-2.53c.04-.32.07-.64.07-.97c0-.33-.03-.65-.07-.97l2.11-1.63c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.39-1.06-.73-1.69-.98l-.37-2.65A.506.506 0 0 0 14 2h-4c-.25 0-.46.18-.5.42l-.37 2.65c-.63.25-1.17.59-1.69.98l-2.49-1c-.22-.08-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64L4.57 11c-.04.32-.07.64-.07.97c0 .33.03.65.07.97l-2.11 1.63c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.39 1.06.73 1.69.98l.37 2.65c.04.24.25.42.5.42h4c.25 0 .46-.18.5-.42l.37-2.65c.63-.25 1.17-.59 1.69-.98l2.49 1c.22.08.49 0 .61-.22l2-3.46c.13-.22.07-.49-.12-.64l-2.11-1.63Z"/></svg>
</button>
<button class="icon-button" onclick="location.href='/about'">
<svg viewBox="0 0 24 24"><path d="M13,9H11V7H13M13,17H11V11H13M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z"/></svg>
</button>
</div>
</div>
<div class="container">
<div class="section">
<h2>Saved Networks</h2>
<div id="saved-networks" style="margin-bottom:15px">
<div style="text-align:center;color:var(--text-secondary);padding:20px">
Loading saved networks...
</div>
</div>
<button class="button" onclick="loadSavedNetworks()" style="background:#2196F3;width:100%">Refresh List</button>
</div>
<div class="section">
<h2>WiFi Configuration</h2>
<form id="wifi-form">
<div style="position:relative">
<input type="text" id="ssid" placeholder="Network name (SSID)" class="input-field" style="width:100%;margin-bottom:10px">
<div id="networks-dropdown" style="position:absolute;top:100%;left:0;right:0;background:var(--bg-tertiary);border:1px solid var(--border);border-radius:5px;max-height:200px;overflow-y:auto;display:none;z-index:100"></div>
</div>
<input type="password" id="password" placeholder="Password" class="input-field" style="width:100%;margin-bottom:10px">
<div class="theme-toggle" style="margin-bottom:10px">
<span style="flex:1;color:var(--text-primary)">Use Static IP</span>
<label class="switch">
<input type="checkbox" id="use-static" onchange="toggleStatic()">
<span class="slider"></span>
</label>
</div>
<div id="static-config" style="display:none;margin-top:10px">
<input type="text" id="static-ip" placeholder="IP Address" class="input-field" style="width:100%;margin-bottom:10px">
<input type="text" id="gateway" placeholder="Gateway" class="input-field" style="width:100%;margin-bottom:10px">
<input type="text" id="subnet" placeholder="Subnet" class="input-field" style="width:100%;margin-bottom:10px">
</div>
<div style="display:flex;gap:15px;justify-content:center;align-items:center;margin-top:20px;flex-wrap:wrap">
<button type="button" class="button" onclick="scanNetworks()" style="background:#d85652">Scan</button>
<button type="submit" class="button" style="background:#4CAF50">Save</button>
</div>
</form>
</div>
<div class="section">
<h2>Interface Color</h2>
<div class="theme-toggle">
<span style="flex:1;color:var(--text-primary)">Dark Mode</span>
<label class="switch">
<input type="checkbox" id="theme-switch" onchange="toggleTheme()">
<span class="slider"></span>
</label>
</div>
</div>
</div>
<script>
// Initialize theme switch state
document.addEventListener('DOMContentLoaded',function(){
  const isDark=!document.body.classList.contains('light');
  document.getElementById('theme-switch').checked=isDark;
  loadSavedNetworks(); // Load saved networks on page load
});
function toggleTheme(){
  document.body.classList.toggle('light');
  localStorage.setItem('theme',document.body.classList.contains('light')?'light':'dark');
}
function toggleStatic(){
  document.getElementById('static-config').style.display=
    document.getElementById('use-static').checked?'block':'none';
}
async function scanNetworks(){
  const btn = event.target;
  const originalText = btn.textContent;
  const ssidField = document.getElementById('ssid');
  const originalSSID = ssidField.value;
  
  // Change to shorter text
  btn.textContent = 'Wait...';
  btn.style.cursor = 'wait';
  btn.disabled = true;
  ssidField.value = 'Searching for networks...';
  ssidField.disabled = true;
  
  const dropdown = document.getElementById('networks-dropdown');
  dropdown.style.display = 'none';
  
  try{
    const r=await fetch('/api/scan');
    if(r.ok){
      const d=await r.json();
      if(d.networks && d.networks.length > 0){
        let html='';
        d.networks.forEach(n=>{
          html+=`<div style="padding:10px;cursor:pointer;border-bottom:1px solid var(--border)" 
                 onmouseover="this.style.background='var(--bg-secondary)'" 
                 onmouseout="this.style.background='transparent'"
                 onclick="selectNetwork('${n.ssid}')">
            ${n.ssid} <span style="color:var(--text-secondary);font-size:12px">(${n.rssi}dBm)</span>
          </div>`;
        });
        dropdown.innerHTML=html;
        dropdown.style.display = 'block';
        ssidField.value = originalSSID;
      } else {
        ssidField.value = 'No networks found';
        setTimeout(()=>{ssidField.value = originalSSID;}, 2000);
      }
    }
  }catch(e){
    ssidField.value = 'Error scanning networks';
    setTimeout(()=>{ssidField.value = originalSSID;}, 2000);
  }finally{
    // Restore button state
    btn.textContent = originalText;
    btn.style.cursor = 'pointer';
    btn.disabled = false;
    ssidField.disabled = false;
  }
}
function selectNetwork(ssid){
  document.getElementById('ssid').value=ssid;
  document.getElementById('networks-dropdown').style.display='none';
  document.getElementById('password').focus();
}
// Close dropdown when clicking outside
document.addEventListener('click', function(e){
  if(!e.target.closest('#ssid') && !e.target.closest('#networks-dropdown') && !e.target.closest('button[onclick*="scanNetworks"]')){
    document.getElementById('networks-dropdown').style.display='none';
  }
});
document.getElementById('wifi-form').onsubmit=async(e)=>{
  e.preventDefault();
  const submitBtn = e.target.querySelector('button[type="submit"]');
  const originalText = submitBtn.textContent;
  submitBtn.textContent = 'Wait...';
  submitBtn.disabled = true;
  
  const config={
    ssid:document.getElementById('ssid').value,
    password:document.getElementById('password').value,
    staticIP:document.getElementById('use-static').checked
  };
  if(config.staticIP){
    config.ip=document.getElementById('static-ip').value;
    config.gateway=document.getElementById('gateway').value;
    config.subnet=document.getElementById('subnet').value;
  }
  
  try{
    const r=await fetch('/api/wifi/config',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(config)
    });
    if(r.ok){
      // Show success message
      const msgDiv = document.createElement('div');
      msgDiv.style.cssText = 'position:fixed;top:80px;left:50%;transform:translateX(-50%);background:var(--success);color:white;padding:15px 30px;border-radius:8px;z-index:2000;box-shadow:0 4px 12px rgba(0,0,0,0.3)';
      msgDiv.textContent = 'Configuration saved! Redirecting to home...';
      document.body.appendChild(msgDiv);
      
      // Redirect to home quickly
      setTimeout(()=>{
        window.location.href = '/';
      }, 500);
    } else {
      alert('Error saving configuration');
      submitBtn.textContent = originalText;
      submitBtn.disabled = false;
    }
  }catch(e){
    alert('Error: ' + e.message);
    submitBtn.textContent = originalText;
    submitBtn.disabled = false;
  }
};
// Load and display saved networks
async function loadSavedNetworks(){
  try{
    const r=await fetch('/api/wifi/saved');
    const d=await r.json();
    const container=document.getElementById('saved-networks');
    
    if(d.networks && d.networks.length>0){
      let html='';
      d.networks.forEach(n=>{
        html+=`<div class="network-item">
          <div style="flex:1">
            <div style="font-weight:500">${n.ssid}</div>
            <div style="font-size:12px;color:var(--text-secondary)">
              ${n.hasPassword?'🔒 Protected':'🔓 Open'}
              ${n.useStaticIP?' • Static IP':''}
            </div>
          </div>
          <div style="display:flex;gap:10px">
            <button class="button" onclick="useNetwork('${n.ssid}')" 
                    style="background:#4CAF50;padding:8px 15px;min-width:auto">Use</button>
            <button class="button" onclick="deleteNetwork('${n.ssid}')" 
                    style="background:#f44336;padding:8px 15px;min-width:auto">Delete</button>
          </div>
        </div>`;
      });
      container.innerHTML=html;
    }else{
      container.innerHTML='<div style="text-align:center;color:var(--text-secondary);padding:20px">No saved networks</div>';
    }
  }catch(e){
    console.error('Error loading saved networks:',e);
  }
}

// Use a saved network
async function useNetwork(ssid){
  try{
    const r=await fetch('/api/wifi/load',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ssid:ssid})
    });
    if(r.ok){
      const d=await r.json();
      // Fill the form with loaded network data
      document.getElementById('ssid').value=d.ssid;
      document.getElementById('password').value=''; // Don't show password
      document.getElementById('use-static').checked=d.useStaticIP;
      if(d.useStaticIP){
        document.getElementById('static-ip').value=d.ip||'';
        document.getElementById('gateway').value=d.gateway||'';
        document.getElementById('subnet').value=d.subnet||'';
        toggleStatic();
      }
      // Show success message
      const msg=document.createElement('div');
      msg.style.cssText='position:fixed;top:80px;left:50%;transform:translateX(-50%);background:var(--success);color:white;padding:15px 30px;border-radius:8px;z-index:2000';
      msg.textContent='Network loaded! Connecting...';
      document.body.appendChild(msg);
      setTimeout(()=>msg.remove(),3000);
    }
  }catch(e){
    alert('Error loading network: '+e.message);
  }
}

// Delete a saved network
async function deleteNetwork(ssid){
  if(!confirm(`Delete network "${ssid}"?`)) return;
  
  try{
    const r=await fetch('/api/wifi/delete',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ssid:ssid})
    });
    if(r.ok){
      loadSavedNetworks(); // Reload list
      // Show success message
      const msg=document.createElement('div');
      msg.style.cssText='position:fixed;top:80px;left:50%;transform:translateX(-50%);background:#f44336;color:white;padding:15px 30px;border-radius:8px;z-index:2000';
      msg.textContent='Network deleted';
      document.body.appendChild(msg);
      setTimeout(()=>msg.remove(),2000);
    }
  }catch(e){
    alert('Error deleting network: '+e.message);
  }
}

if(localStorage.getItem('theme')==='light'){
  document.body.classList.add('light');
}
</script>
</body>
</html>